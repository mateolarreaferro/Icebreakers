<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Agent Simulator</title>

  <!-- libs (kept) -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />

  <!-- font & basic palette -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary:   #2563eb;        /* blue-600  */
      --primary-inset: #1d4ed8;    /* blue-700  */
      --text:      #334155;        /* slate-700 */
      --bg:        #f8fafc;        /* slate-50  */
      --card:      #ffffff;
      --border:    #e2e8f0;        /* slate-200 */
      --bubble-them: #e5e7eb;      /* slate-200 */
    }
    /* reset + base */
    *,*::before,*::after{box-sizing:border-box}html,body{margin:0;padding:0}
    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      font-size:15px;line-height:1.48;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    h1{
      text-align:center;
      font-size:1.75rem;
      margin:28px 0 22px;
      color:var(--primary-inset);
      letter-spacing:-.5px;
    }

    /* layout */
    .container{max-width:820px;margin:0 auto;padding:0 24px 48px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 6px 14px rgba(0,0,0,.04);
      padding:28px 24px 32px;
      margin-bottom:32px;
    }

    /* inputs */
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:.9rem}
    input,select,textarea{
      width:100%;padding:10px 12px;font-size:.9rem;
      border:1px solid var(--border);border-radius:6px;
      background:#fff;resize:none;
    }
    .input-with-prefix{display:flex;flex-direction:column;border:1px solid var(--border);border-radius:6px}
    .input-prefix{padding:10px 12px;border-bottom:1px solid var(--border);background:#f1f5f9;font-size:.9rem}
    .input-with-prefix textarea{border:0;border-radius:0 0 6px 6px;min-height:90px}

    /* buttons */
    button{
      cursor:pointer;border:0;border-radius:6px;
      background:var(--primary);color:#fff;
      padding:11px 20px;font-size:.92rem;font-weight:600;
      transition:background .18s ease;
    }
    button:hover{background:var(--primary-inset)}
    button:disabled{background:var(--border);cursor:not-allowed;color:#9ca3af}

    /* dialogue area */
    .dialogue{
      margin-top:26px;padding-right:6px;max-height:70vh;overflow-y:auto;
    }
    .line{display:flex;gap:6px;margin-bottom:14px;opacity:0;animation:fadein .25s forwards}
    .line.me{justify-content:flex-end}
    .bubble{
      max-width:72%;padding:10px 14px;border-radius:18px;
      box-shadow:0 2px 6px rgba(0,0,0,.05);position:relative;
    }
      .speaker{
        display:block;font-size:.72rem;font-weight:600;margin-bottom:4px;opacity:.8
      }
      .message{display:block;word-wrap:break-word}

    .me .bubble{background:var(--primary);color:#fff}
    .me .speaker{color:#c7d2fe;opacity:.9}
    .them .bubble{background:var(--bubble-them);color:#000}
    .survivors{margin-top:20px;font-weight:600}

    @keyframes fadein{to{opacity:1}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Multi-Agent Simulator</h1>

    <!-- start card -->
    <div id="start-card" class="card">
      <div class="form-group">
        <label for="scenario">Scenario</label>
        <select id="scenario">
          <option value="lifeboat">Spaceship – Lifeboat Crisis</option>
          <option value="bank_heist">Bank Heist – Hostage Dilemma</option>
          <option value="mars_outpost">Mars Outpost – Oxygen Rationing</option>
          <option value="submarine_leak">Submarine – Rising Water</option>
          <option value="expedition_blizzard">Arctic Expedition – Shelter Shortage</option>
          <option value="time_paradox">Time Lab – Paradox Lockdown</option>
        </select>
      </div>

      <div class="form-group">
        <label for="agent-name">Your agent’s name</label>
        <input id="agent-name" type="text" required />
      </div>

      <div class="form-group">
        <label for="agent-persona">Your agent’s persona</label>
        <div class="input-with-prefix">
          <span class="input-prefix">You are…</span>
          <textarea id="agent-persona" placeholder="a Master's student at Stanford University who…" required></textarea>
        </div>
      </div>

      <button id="simulate-btn">Simulate</button>
    </div>

    <!-- results card -->
    <div id="result-card" class="card" style="display:none">
      <button id="reset-btn" style="float:right">New Simulation</button>
      <h3 id="scenario-title" style="margin-top:0"></h3>

      <div id="dialogue" class="dialogue"></div>
      <div id="survivors" class="survivors"></div>
    </div>
  </div>

  <script>
    // ---------- elements ----------
    const selScenario  = document.getElementById("scenario");
    const agentName    = document.getElementById("agent-name");
    const agentPersona = document.getElementById("agent-persona");
    const simulateBtn  = document.getElementById("simulate-btn");
    const resetBtn     = document.getElementById("reset-btn");
    const startCard    = document.getElementById("start-card");
    const resultCard   = document.getElementById("result-card");
    const scenarioTitle= document.getElementById("scenario-title");
    const dialogueBox  = document.getElementById("dialogue");
    const survivorsBox = document.getElementById("survivors");

    // outcome labels per scenario
    const outcomeLabel = {
      lifeboat:            "Survivors",
      bank_heist:          "Released",
      mars_outpost:        "Oxygen Recipients",
      submarine_leak:      "Dive Team",
      expedition_blizzard: "Sheltered",
      time_paradox:        "Stabilized"
    };

    // ---------- helpers ----------
    function lineHTML(name, text, me){
      const side = me ? "me" : "them";
      return `
        <div class="line ${side}">
          <div class="bubble">
            <span class="speaker">${name}</span>
            <span class="message">${text}</span>
          </div>
        </div>`;
    }
    function renderDialogue(raw, you){
      dialogueBox.innerHTML = "";
      raw.split("\n").forEach(l=>{
        if(!l.trim()) return;
        const [speaker,...rest] = l.split(":");
        const text  = rest.join(":").trim();
        const isMe  = speaker.trim() === you;
        dialogueBox.insertAdjacentHTML("beforeend", lineHTML(speaker.trim(), text, isMe));
      });
      dialogueBox.scrollTop = dialogueBox.scrollHeight;
    }

    // ---------- simulate ----------
    simulateBtn.addEventListener("click", ()=>{
      const name    = agentName.value.trim();
      const persona = agentPersona.value.trim();
      const scenario_id = selScenario.value;
      if(!name || !persona){alert("Please enter both name and persona.");return}

      simulateBtn.disabled = true;
      fetch("/simulate",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({scenario_id,name,persona})
      })
      .then(r=>r.json())
      .then(res=>{
        startCard.style.display="none";
        resultCard.style.display="block";
        scenarioTitle.textContent=selScenario.selectedOptions[0].textContent;
        renderDialogue(res.dialogue, name);
        survivorsBox.textContent = (res.survivors && res.survivors.length)
          ? `${outcomeLabel[scenario_id] || "Outcome"}: ${res.survivors.join(", ")}`
          : "";
      })
      .finally(()=>simulateBtn.disabled=false);
    });

    resetBtn.addEventListener("click", ()=>{
      resultCard.style.display="none";
      startCard.style.display="block";
      agentName.value="";
      agentPersona.value="";
      survivorsBox.textContent="";
      dialogueBox.innerHTML="";
    });
  </script>
</body>
</html>
